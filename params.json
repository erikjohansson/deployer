{"name":"Deployer","body":"Assumptions:\r\n\r\n  * You are using Ubuntu 10.04\r\n  * You are able to log in as `root` via `ssh`\r\n\r\n\r\n### Step-by-step preparation\r\n\r\nFollow the step-up-step guide to get the initial preparations done.\r\nAt the end of the process (this section) you'll see a summary of what we've just done.\r\n\r\nLog in to your server as the `root` user:\r\n\r\n    ssh root@yourip\r\n\r\nUpdate the package list and upgrade existing packages:\r\n\r\n    apt-get -y update && apt-get -y upgrade\r\n\r\nInstall the UFW Firewall package:\r\n\r\n    apt-get install ufw\r\n\r\nAdd the `deployer` user and add it to `/etc/sudoers`:\r\n\r\n    adduser deployer\r\n    echo \"deployer ALL=(ALL) NOPASSWD: ALL\" >> /etc/sudoers\r\n\r\nChange the SSH port (security measure). Change the `SSH_PORT` variable to whatever you want to change the port to:\r\n\r\n    SSH_PORT=22 # CHANGE THIS TO WHATEVER NUMBER YOU WANT\r\n    sed -i \"s/Port 22/Port $SSH_PORT/\" /etc/ssh/sshd_config\r\n    service ssh reload\r\n\r\nConfigure the firewall (UFW) to allow the `$SSH_PORT`, `80` (http) and `443` (https) ports:\r\n\r\n    ufw allow $SSH_PORT\r\n    ufw allow 80\r\n    ufw allow 443\r\n    ufw --force enable\r\n\r\nFinally, lock the `root` (disabling the password):\r\n\r\n    passwd -l root\r\n\r\nFrom now on, SSH in to your VPS as `deployer` and `sudo su` to log in as `root`.\r\n\r\n    exit\r\n\r\n\r\nThe following has now been accomplished:\r\n\r\n  * Your server's package list has been updated\r\n  * Your server's packages have been upgraded to the latest versions\r\n  * Your server has been protected with a firewall (UFW) by blocking all ports except `$SSH_PORT`, `80` and `443`\r\n  * Your server has been protected by disabling direct access to the root user, log in as `deployer` and `sudo su` to root\r\n  * Your server is now only accessible through `$SSH_PORT` as the `deployer` user\r\n\r\n\r\n### On your local machine\r\n\r\nHere are two useful commands (depending on your local development OS).\r\n\r\nIf you're on Linux:\r\n\r\n    ssh-add\r\n\r\nIf you're on Mac OSX:\r\n\r\n    ssh-add -K\r\n\r\nThis command will allow you to use Capistrano's `agent_forwarding` option. It's a VERY convenient when deploying from a remote Git repository. For example if your application resides in a GitHub repository, you would normally have to log in to your server through ssh, run `ssh git@github.com` to add GitHub to the `known_hosts`. You would then also need to generate a new ssh key and upload that to GitHub. So, instead of doing all that, agent forwarding will allow you to use your local ssh keys and forward the agent to bypass all of this additional configuration on the server. You only have to run the above command once and it'll work for any deployments in the future.\r\n\r\n\r\n### Capistrano Configuration\r\n\r\nCapistrano will help in the following ways:\r\n\r\n  * It will provision your server with necessary packages (PostgreSQL, MongoDB, Redis, Nginx, etc)\r\n  * It will configure/prepare these packages for use with your application and the OS\r\n  * It will deploy your application\r\n\r\nCopy over the `deploy.rb` file and `recipes/` folder to your application in the `config` directory. The recipes in `recipes/` will be included one by one from the `config/deploy.rb`. Be sure only to include the recipes you are going to use. Open up `config/deploy.rb` and remove any recipes from the array of recipes that you're not going to use.\r\n\r\nOnce done, be sure to review all the tasks briefly in `deploy.rb` and in all the recipe's files/templates located in `config/recipes` and `config/recipes/templates/` to see if anything needs to be tweaked for your deployment purposes. Most of it have common defaults (for Rails, Active Record, Mongoid, etc), and will sometimes \"just work\" out of the box depending on your app setup. But, these are just basic recipes/templates to get up and running by getting the standard settings/config out of the way. They are meant to be tweaked when necessary.\r\n\r\nAssumptions are mostly based on Ruby and JRuby deployments with Puma and TorqueBox, but it should be easy to modify it for anything else like Unicorn and Trinidad. You'd typically define any custom deployment related tasks inside `config/deploy.rb`. If you're adding a whole \"module/recipe\" such as another database, search engine or similar utilities, it's best to create a separate recipe in `config/recipes` for it. Examples of things that go in to `deploy.rb`:\r\n\r\n  * bundle command with Bundler\r\n  * running database migrations for ORM's like Active Record\r\n  * asset precompile rake task for asset pipeline with Rails\r\n  * app server starts to apply changes (TorqueBox, Puma, etc)\r\n  * setting up additional shared folder data for deploy:setup\r\n  * setting up additional shared folder symlinks for deploy\r\n  * server-related settings such as ip's, roles, ssh port, etc\r\n\r\nAdd such tasks to the `config/deploy.rb`.\r\n\r\n\r\n### Provisioning, Setup & Deployment\r\n\r\nOnce you've fully configured/tweaked/added all your tasks and recipes. You may proceed by provisioning the server with:\r\n\r\n    cap deploy:install\r\n\r\nThis may take a while depending on the amount of recipes you're using. Once done, all the packages should be installed and ready for use. All \"service\"-type packages like databases and key value stores come with little Upstart scripts. These scripts are all configured to allow you to start/stop/restart these services using commands like:\r\n\r\n    sudo [start|stop|restart] postgresql\r\n    sudo [start|stop|restart] mongodb\r\n    sudo [start|stop|restart] redis\r\n    sudo [start|stop|restart] torquebox\r\n    # etc\r\n\r\nThey are also configured to automatically start up when the server boots up, and to automatically restart when a service crashes in order to recover. So basically it'll also act as a \"process monitor\" like \"monit\" / \"god\". It's Ubuntu's initsystem and it's very reliable. Deployer provides a handy set of Capistrano tasks to perform these operations from your local machine. Run `cap -T` to view all the available tasks.\r\n\r\nNow, with everything installed, run the following to bootstrap/configure/setup everything:\r\n\r\n    cap deploy:setup\r\n\r\nSuch things can be:\r\n\r\n  * Creating a user/database(with password) for PostgreSQL\r\n  * Writing a customized `.bashrc` file to `/home/deployer/.bashrc`\r\n  * Writing a customized nginx virtual host file specific to your application to `/etc/nginx/sites-enabled`\r\n  * Writing a customized redis configuration file\r\n\r\nThis task of course also sets up your `/home/deployer/applications/shared/` directory (provided by Capistrano itself).\r\n\r\nFinally, once everything is in place, go ahead and deploy your application with:\r\n\r\n    cap deploy\r\n\r\nThis may or may not work. It is often the case that there is either a typo somewhere in any configuration/tweaks you made. Just resolve them and it should work.\r\n\r\n\r\n### Potential gotchas\r\n\r\n  * gem install jruby-ssl on deploy before `bundle install` (this is done for you when the rbenv module installs jruby)\r\n  * use same torquebox version in Gemfile as installed on the server, it might conflict\r\n\r\n\r\n### Packages (PPA)\r\n\r\nPackages on Ubuntu are generally horribly out-dated. This is why we have [PPA](https://launchpad.net/ubuntu/+ppas)'s. Deployer makes use of PPA for various packages, including:\r\n\r\n* Nginx\r\n* PostgreSQL\r\n* MongoDB\r\n* Redis\r\n* VIM\r\n\r\nThis ensures that newer versions (usually the latest) are installed, rather than 6-24 month old versions.\r\n","tagline":"An easy-to-use set of Capistrano tasks/recipes for provisioning and deploying Ruby/JRuby applications to your servers.","google":"ruby jruby rails capistrano tasks deployment provisioning recipes tasks","note":"Don't delete this file! It's used internally to help with page regeneration."}